name: Visual Regression Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DB_URL: postgresql://mock:mock@localhost:5432/mockdb
      NEXT_PUBLIC_BASE_URL: http://localhost:3000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          frozen-lockfile: 'false'

      - name: Install Playwright browsers
        uses: ./.github/actions/playwright

      - name: Build application
        run: pnpm build

      - name: Start server for visual tests
        run: pnpm start &
        env:
          DB_URL: postgresql://mock:mock@localhost:5432/mockdb
          NEXT_PUBLIC_BASE_URL: http://localhost:3000

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run visual regression tests
        run: pnpm test:visual:ci
        env:
          CI: true

      - name: Upload visual test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: |
            test-results/
            playwright-report/
            e2e/visual/**/*.png

      - name: Comment on PR with visual changes
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Visual Regression Tests Failed**\n\nThe visual tests detected changes in the UI. Please review the attached screenshots to ensure these changes are intentional.\n\n- Check the "visual-test-results" artifact for before/after screenshots\n- If changes are expected, run `pnpm test:visual` locally to update baselines'
            })
